# Database Migrations (using dbmate)

This directory manages database schema migrations using `dbmate`.

## Prerequisites

1.  `dbmate` CLI tool installed.
2.  A `.env` file in the project root defining the `DATABASE_URL`.
    Example for local development with Docker:
    `DATABASE_URL="postgresql://admin:iamhipster@localhost:5432/chatwithoats?sslmode=disable"`
3.  PostgreSQL database server running and accessible (e.g., via Docker Compose).

## Workflow

### 1. Create a New Migration

To generate a new migration file:
```bash
dbmate new <migration_name>
```
Example: `dbmate new create_products_table`
This creates a new SQL file in `db/migrations/` with a timestamp prefix (e.g., `YYYYMMDDHHMMSS_create_products_table.sql`). Edit this file to define your schema changes.

```sql
-- migrate:up
-- SQL for applying the migration
CREATE TABLE example_table (id SERIAL PRIMARY KEY);

-- migrate:down
-- SQL for rolling back the migration
DROP TABLE IF EXISTS example_table;
```

### 2. Apply Migrations

To apply all pending migrations to the database:
```bash
dbmate up
```
This command will:
- Create the database if it doesn't exist (based on `DATABASE_URL`).
- Apply any new migrations in chronological order.
- Update the `db/schema.sql` file to reflect the current database structure.

### 3. Rollback Migrations

To roll back the most recently applied migration:
```bash
dbmate rollback
```
Or:
```bash
dbmate down
```

### Schema File (`db/schema.sql`)

This file is automatically generated/updated by `dbmate up` or `dbmate rollback`. It represents the complete current schema of your database. It's recommended to commit this file to version control to track schema changes.

### Status

To check the status of migrations:
```bash
dbmate status
``` 